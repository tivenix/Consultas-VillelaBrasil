from selenium.webdriver.common.by import By
from selenium.webdriver import Chrome
from selenium.webdriver.chrome.service import Service
#from webdriver_manager.chrome import ChromeDriverManager
import pandas as pd
import numpy as np
#from devtools_ai.selenium import SmartDriver
from selenium import webdriver
from selenium.webdriver.common.keys import Keys
from selenium.webdriver.common.by import By
from selenium.webdriver.support import expected_conditions as EC
from selenium.webdriver.support.wait import WebDriverWait
from selenium.common.exceptions import NoSuchElementException
from selenium.common.exceptions import ElementClickInterceptedException
import time
import re
from bs4 import BeautifulSoup


df = pd.read_excel("lista 3.xlsx",header=0)
df['index'] = range(1, len(df) + 1)
df.set_index('index',inplace=True)
df.columns=['CNPJ'] 
CNPJ = df['CNPJ']

PATH = "C:\Program Files (x86)\chromedriver.exe"
driver = webdriver.Chrome(PATH)
driver.get("https://portal.aceleradorvillela.com/")
WebDriverWait(driver,10).until(EC.element_to_be_clickable((By.ID,'input-email')))
login = driver.find_element(By.ID, "input-email")
login.send_keys("felipe.machado@villelabrasil.com.br")
password = driver.find_element(By.ID,"input-password")
password.send_keys("villela2022")
logbutton = driver.find_element(By.XPATH,"/html/body/ngx-app/nb-auth/nb-layout/div/div/div/div/div/nb-layout-column/nb-card/nb-card-body/nb-auth-block/nb-login/nb-card/nb-card-body/form/button")
logbutton.click()
driver.maximize_window()
try:
    WebDriverWait(driver, 10).until(
        EC.presence_of_element_located((By.XPATH, '/html/body/ngx-app/ngx-pages/ngx-one-column-layout/nb-layout/div/div/div/nb-sidebar/div/div/nb-menu/ul'))
    )
finally:
    time.sleep(3)

regularize = driver.find_element(By.PARTIAL_LINK_TEXT, 'Funil')    
regularize.click()


consultas = driver.find_element(By.XPATH, '/html/body/ngx-app/ngx-pages/ngx-one-column-layout/nb-layout/div/div/div/div/div/nb-layout-column/ngx-listar-regularize/div/div/nb-tabset/ul/li[3]')
consultas.click()
searchbutton = driver.find_element(By.XPATH,'/html/body/ngx-app/ngx-pages/ngx-one-column-layout/nb-layout/div/div/div/div/div/nb-layout-column/ngx-listar-regularize/div/div/nb-tabset/nb-tab[3]/nb-card/nb-card-body/nb-tabset/nb-tab[1]/div/div/div[2]/button')
searchcnpj = driver.find_element(By.XPATH,'/html/body/ngx-app/ngx-pages/ngx-one-column-layout/nb-layout/div/div/div/div/div/nb-layout-column/ngx-listar-regularize/div/div/nb-tabset/nb-tab[3]/nb-card/nb-card-body/nb-tabset/nb-tab[1]/div/div/div[1]/input')
src = driver.page_source
soup = BeautifulSoup(src, 'lxml')
time.sleep(2)
toast = soup.find('nb-toast',{'class':'ng-tns-c37-71 ng-trigger ng-trigger-fadeIn status-danger destroy-by-click has-icon custom-icon ng-star-inserted'})
x = 0
#y = 9000

toast3 = soup.find('cdk-overlay-0')
alert = driver.find_element(By.XPATH,'/html/body/ngx-app/ngx-pages/ngx-one-column-layout/nb-layout/div/div/div/div/div/nb-layout-column/ngx-listar-regularize/div/div/nb-tabset/nb-tab[3]/nb-card/nb-card-body/nb-tabset/nb-tab[1]/nb-alert')
teste= soup.find('div',{'class':'ng-tns-c37-71 ng-trigger ng-trigger-fadeIn status-danger destroy-by-click has-icon custom-icon ng-star-inserted'})
lista = []
for x in range(1,25):
    searchcnpj.send_keys(CNPJ[x])
    #WebDriverWait(driver,10).until(EC.visibility_of_element_located(searchbutton))
    WebDriverWait(driver,10).until(EC.element_to_be_clickable(searchbutton))    
   
    try:
        searchbutton.click()
    except ElementClickInterceptedException:
        pass
    searchcnpj.clear()
    if alert.is_displayed():
        print(CNPJ[x]," cliente")
        #CNPJ.drop[x]
    else:
        #pd.Series.to_excel(sheet_name='teste',)
        print(CNPJ[x],' Não é cliente')
    
else: 
    WebDriverWait(driver, 1).until(
        EC.element_to_be_clickable((By.XPATH, '/html/body/ngx-app/ngx-pages/ngx-one-column-layout/nb-layout/div/div/div/div/div/nb-layout-column/ngx-listar-regularize/div/div/nb-tabset/nb-tab[3]/nb-card/nb-card-body/nb-tabset/nb-tab[1]/div/div/div[2]/button'))
    )
if driver.find_element(By.XPATH,'//*[@id="cdk-overlay-0"]/nb-toastr-container/nb-toast'):
            pass
else:
    WebDriverWait(driver,1).until(EC.element_to_be_clickable(searchbutton))
    if driver.find_element(By.XPATH,'//*[@id="cdk-overlay-0"]/nb-toastr-container/nb-toast'):
            pass
searchcnpj.send_keys(CNPJ[x + 1])
searchbutton.click()
searchcnpj.clear()
